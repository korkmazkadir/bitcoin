---
title: "Bitcoin++ Statistics"
author: "Kadir Korkmaz"
date: "Nov 09, 2021"
output: pdf_document
knit: (function(inputFile, encoding) { 
      workingDir <- '/home/kadir/Desktop/bitcoin++_120seconds_30rounds';
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        knit_root_dir = workingDir,
                        output_file=file.path(workingDir, 'experiment-report.pdf')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


##Configuration

We use 10 machines from G5K 
We deployed 1000 Bitcoin & Bitcoin++ nodes.
Bandwidth 20mbps per process, Latency 50 ms 

In these experiments, mining time is 120 seconds.
An elected leader chooses CL-1 subleaders.

We plot the round latency, throughput and block dissemination statistics.


```{r data, include=FALSE}
library(dplyr)
library(ggplot2)
library(knitr)


experimentDF <- read.table('experiment.stats', sep = '\t',header = FALSE)



colnames(experimentDF) <- c( "MacroBlockSize", "ConcurrencyConstant", "ChunkSize",  "NodeID","Round","Type","ElapsedTime")


printSummaryStats <- function(df, column) {
  summ <- df %>% summarise(min = min(column), mean= mean(column), sd= sd(column), max = max(column))
  kable(summ)
}

printConfidenceInterval <- function(column) {
  r <- CI(column, ci=0.95)
  kable(r)
}


printMeanBarChart <- function(df){
    
  grouped_df <- df %>% 
                  group_by(MacroBlockSize, ConcurrencyConstant ) %>%
                  summarise(
                    Min = min(ElapsedTime),
                    Q1 = quantile(ElapsedTime, 0.25),
                    Median = median(ElapsedTime),
                    Mean = mean(ElapsedTime),
                    Q3 = quantile(ElapsedTime, 0.75),
                    Max = max(ElapsedTime)
                  )
  
  p <- ggplot(grouped_df, aes(x=MacroBlockSize, y=Mean, group=ConcurrencyConstant, color=factor(ConcurrencyConstant))) +
    geom_line(aes( linetype=factor(ConcurrencyConstant), color=factor(ConcurrencyConstant) ))+
    geom_point() +
    labs( x = "Macro Block Size (MB)", y = "Mean Elapsed Time (ms)", color = "CC", linetype="CC" )+
    theme(legend.position="top",legend.box="vertical", legend.margin=margin())+
    scale_x_continuous(labels = as.character(grouped_df$MacroBlockSize), breaks = grouped_df$MacroBlockSize)
  
  
  
  t <- kable(grouped_df, n=100)

  return( list("plot" = p , "table" = t ))
}

```


```{r, echo=FALSE, warning=FALSE}

blockReceivedDF <- experimentDF %>% filter(Type == "BLOCK_RECEIVED")
endOfRound <-experimentDF %>% filter(Type == "END_OF_ROUND")

throughputDF <- experimentDF %>% filter(Type == "END_OF_ROUND")
throughputDF$ElapsedTime <- throughputDF$ElapsedTime / 1000 # elapsed time in seconds
throughputDF$MacroBlockSize <- throughputDF$MacroBlockSize / 1000 # block size in KB
throughputDF$Throughput <- throughputDF$MacroBlockSize * throughputDF$ConcurrencyConstant / throughputDF$ElapsedTime

```


\newpage
## Metadata

```{r, echo=FALSE, fig.height=4, warning=FALSE}

metadata <- endOfRound %>% 
              group_by(ConcurrencyConstant) %>%
              summarise(DistinctRoundCount = n_distinct(Round), TotalRoundCount=n())

kable(metadata)


```

\newpage
## Round Latency

```{r, echo=FALSE, fig.height=4, warning=FALSE}

ggplot(endOfRound, aes(x=as.factor(ConcurrencyConstant), y=ElapsedTime)) + 
    geom_boxplot(fill="slateblue", alpha=0.2) + 
    xlab("ConcurrencyConstant") +
    ylab("Round Latency(ms)") +
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE))



grouped_endOfRound <- endOfRound %>% 
                group_by(MacroBlockSize, ConcurrencyConstant ) %>%
                summarise(
                  Min = min(ElapsedTime),
                  Q1 = quantile(ElapsedTime, 0.25),
                  Median = median(ElapsedTime),
                  Mean = mean(ElapsedTime),
                  Q3 = quantile(ElapsedTime, 0.75),
                  Max = max(ElapsedTime)
                )


kable(grouped_endOfRound, n=100)
```


\newpage
## Throughput

```{r, echo=FALSE, fig.height=4, warning=FALSE}

ggplot(throughputDF, aes(x=as.factor(ConcurrencyConstant), y=Throughput)) +
    geom_boxplot(fill="slateblue", alpha=0.2, outlier.shape=NA) +
    xlab("ConcurrencyConstant") +
    ylab("Throughput (KB/S)") +
    scale_y_continuous(limits = quantile(throughputDF$Throughput, c(0.1, 0.9)), labels = function(x) format(x, scientific = FALSE))


# ggplot(throughputDF, aes(x=as.factor(ConcurrencyConstant), y=Throughput)) + 
#     geom_boxplot(fill="slateblue", alpha=0.2) + 
#     xlab("ConcurrencyConstant") +
#     ylab("Throughput (KB/S)") +
#     scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 


grouped_throughputDF <- throughputDF %>% 
                group_by(MacroBlockSize, ConcurrencyConstant ) %>%
                summarise(
                  Min = min(Throughput),
                  Q1 = quantile(Throughput, 0.25),
                  Median = median(Throughput),
                  Mean = mean(Throughput),
                  Q3 = quantile(Throughput, 0.75),
                  Max = max(Throughput)
                )


kable(grouped_throughputDF, n=100)
```


\newpage
## Block Dissemination Time

```{r, echo=FALSE, fig.height=4, warning=FALSE}

ggplot(blockReceivedDF, aes(x=as.factor(ConcurrencyConstant), y=ElapsedTime)) + 
    geom_boxplot(fill="slateblue", alpha=0.2) + 
    xlab("ConcurrencyConstant") +
    ylab("Dissemination Time(ms)") +
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE))


grouped_blockReceivedDF <- blockReceivedDF %>% 
                group_by(MacroBlockSize, ConcurrencyConstant ) %>%
                summarise(
                  Min = min(ElapsedTime),
                  Q1 = quantile(ElapsedTime, 0.25),
                  Median = median(ElapsedTime),
                  Mean = mean(ElapsedTime),
                  Q3 = quantile(ElapsedTime, 0.75),
                  Max = max(ElapsedTime)
                )


kable(grouped_blockReceivedDF, n=100)
```



\newpage
## Disseminated Blocks per round

```{r, echo=FALSE, fig.height=4, warning=FALSE}

blocks_df <- blockReceivedDF %>% 
              group_by(NodeID, Round, ConcurrencyConstant) %>%
              summarize(BlockCount = n())

blocks_df <- blocks_df %>%  
             group_by(ConcurrencyConstant) %>%
             summarize(MeanBlockCount = mean(BlockCount))

blocks_df$ExtraPercent <- (blocks_df$MeanBlockCount - blocks_df$ConcurrencyConstant)  * 100  / blocks_df$ConcurrencyConstant

ggplot(data=blocks_df, aes(x= as.factor(ConcurrencyConstant), y=blocks_df$ExtraPercent)) +
  geom_bar(stat="identity")

head(blocks_df)


```